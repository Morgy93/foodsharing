.defaults: &defaults
  image: registry.gitlab.com/foodsharing-dev/images/ci:1.6

  # run it on our foodsharing ci server
  tags:
  - non-shared

.ssh: &ssh
  before_script:
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$DEPLOY_SSH_KEY")
  - mkdir -p ~/.ssh
  # For Docker builds disable host key checking. Be aware that by adding that
  # you are suspectible to man-in-the-middle attacks.
  # WARNING: Use this only with the Docker executor, if you use it with shell
  # you will overwrite your user's SSH config.
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

.deploy: &deploy
  <<: *defaults
  <<: *ssh
  stage: deploy
  script:
  - (cd deployer && composer install)
  - deployer/vendor/bin/dep deploy $CI_ENVIRONMENT_NAME --revision $CI_COMMIT_SHA
  - ./scripts/deploy.notifyslack.sh

stages:
- build
- test
- deploy

build:
  <<: *defaults
  image: node:10
  stage: build
  script:
  - (cd client && yarn && yarn lint && yarn build)
  cache:
    key: client:build
    paths:
    - client/node_modules
  artifacts:
    paths:
    - assets

build:docs:
  <<: *defaults
  image: node:10
  stage: build
  script:
  - yarn global add gitbook-cli
  - gitbook install docs
  - gitbook build docs docs/dist
  cache:
    key: build-docs
    paths:
    - docs/node_modules
  artifacts:
    paths:
    - docs/dist
  only:
  - master

test:
  <<: *defaults
  script:
  - ./scripts/ci.test
  after_script:
  # collect artifacts
  - docker cp foodsharing_ci_selenium:/home/seluser/Downloads tests/_output/
  - docker cp foodsharing_ci_app:/app/tests/_output/ tests/_output
  - docker logs foodsharing_ci_app --since 15m --timestamps &> tests/_output/logs-app.txt
  - docker logs foodsharing_ci_mailqueuerunner --since 15m --timestamps &> tests/_output/logs-mailqueuerunner.txt
  # stop/kill all the containers
  - FS_ENV=ci ./scripts/rm
  # collect any test output
  artifacts:
    when: always
    paths:
    - tests/_output

test:client:
  <<: *defaults
  image: node:10
  stage: test
  script:
  - (cd client && yarn && yarn test)
  cache:
    key: client:build
    paths:
    - client/node_modules

deploy:beta:
  <<: *deploy
  environment:
    name: beta
    url: https://beta.foodsharing.de
  only:
  - master

deploy:docs:
  <<: *defaults
  <<: *ssh
  stage: deploy
  dependencies:
  - build:docs
  script:
  - rsync -avz --delete docs/dist/ "deploy@banana.foodsharing.de:docs-deploy/"
  environment:
    name: docs
    url: https://devdocs.foodsharing.de
  only:
  - master

deploy:production:
  <<: *deploy
  environment:
    name: production
    url: https://foodsharing.de
  only:
  - production

variables:
  # https://docs.docker.com/engine/userguide/storagedriver/selectadriver/
  # https://gitlab.com/gitlab-org/gitlab-ce/issues/19971
  DOCKER_DRIVER: overlay
