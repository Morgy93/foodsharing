#!/bin/bash

export FS_ENV=ci

set -e

dir=$(dirname "$0")

. $dir/inc.sh

if [ "x" != "x$CI_BUILD_TOKEN" ]; then
  echo "Logging into docker registry"
  docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
fi

echo "Building images"

for name in app chat web; do
  dc build $name &
done

wait

echo "Bring up containers"
dc up -d --no-build

echo "Waiting for mysql to start"
wait-for-mysql

echo "Initializing database"
sql-query mysql 'drop database if exists foodsharing; create database foodsharing'

migratedb foodsharing

$dir/mkdirs

echo "Installing composer deps"
exec-in-container-asroot app composer install

echo "Running tests"
exec-in-container app vendor/bin/codecept run "$@"

echo "Running chat tests"
run-in-container chat npm test

echo "Checking code style"
exec-in-container app vendor/bin/php-cs-fixer --dry-run --cache-file=vendor/php-cs-cache fix

echo "Done!"
