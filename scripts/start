#!/bin/bash

export FS_ENV=dev

# set -e tells the shell to exit as a command exits with non-zero status, i.e. fails
set -e

dir=$(dirname "$0")

# . is a bash builtin, synonymous to source
# it runs the content of the argument as if there were here (without launching a subshell!)
. $dir/inc.sh

echo "Bringing up containers"
dc up -d
$dir/mkdirs

echo "Running composer install"
exec-in-container app composer install
exec-in-container-asroot app rm -rf cache/.views-cache cache/di-cache.php

echo "Waiting for mysql"
wait-for-mysql

# Creating db
createdb foodsharing

# Migrating db
migratedb foodsharing || true

# Building assets
$dir/build-assets

echo
echo "  Go visit http://localhost:18080 now!"
echo
echo "  Or view logs with:"
echo
echo "    ./scripts/docker-compose logs -f"
echo
echo "  Or seed the db with some data:"
echo
echo "    ./scripts/seed"
echo
