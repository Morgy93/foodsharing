#!/bin/bash

export FS_ENV=test

set -e

. $(dirname "$0")/inc.sh

#echo "Installing chat dependencies"
#install-chat-dependencies

echo "Bring up containers"
dc up -d

echo "Waiting for mysql to start"
wait-for-mysql

echo "Initializing database"
sql-query mysql 'drop database if exists foodsharing; create database foodsharing'

echo "Running migations"
migratedb foodsharing

echo "Running composer install"
exec-in-container app composer install

echo "Running tests"
exec-in-container selenium "find /home/seluser/Downloads -type f -print0 | xargs -r -n 1 -0 rm"
exec-in-container-asroot app rm -rf tmp/.views-cache
exec-in-container app vendor/bin/codecept run "$@"

echo "Running chat tests"
run-in-container chat npm test

echo "Done!"
